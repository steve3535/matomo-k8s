variables:
    MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}

stages:
    - validate
    - deploy

before_script:
    - |
      cat <<EOF >manifests/db/0-db-matomo-secrets.yaml 
      apiVersion: v1
      kind: Secret
      metadata:  
        name: db-matomo-secrets
        namespace: matomo 
      data:
          mariadb-password: $(echo -n "$MARIADB_PASSWORD" | base64)
          mariadb-root-password: $(echo -n "$MARIADB_ROOT_PASSWORD" | base64)
      EOF   

validate-db-scripts:
  stage: validate 
  script:
    - kubectl apply -f manifests/db/ --dry-run=client   
  tags:
    - k8s 
validate-deployment:
  stage: validate 
  script:
    - kubectl rollout status deployment db-matomo 
  tags:
    - k8s 
validate-db-service:
    stage: validate
    script:
      - echo "Validating DB connection ..."
      - kubectl config set-context --namespace matomo --current      
      - |
        if kubectl run mysql-client-${CI_JOB_ID} -i --image=mysql --rm -- \
        mysql -hdb-matomo.matomo -uroot -p${MARIADB_ROOT_PASSWORD} -e "select 1";then 
        echo "DB connection successful" 
        exit 0
        fi 
        echo "DB connection failed"
        exit 1          
        
    tags:
      - k8s
